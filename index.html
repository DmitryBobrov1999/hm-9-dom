<!DOCTYPE html>
<html>
	<head>
		<title>Проект "Комменты"</title>
		<meta charset="utf-8" />
		<link rel="stylesheet" href="styles.css" />
	</head>
	<body>
		<div class="container">
			<ul id="idComments" class="comments"></ul>
			<!-- <div class="add-comment">Комментарий добавляется...</div> -->
			<div class="add-form">
				<input
					id="nameInput"
					type="text"
					class="add-form-name"
					placeholder="Введите ваше имя"
				/>
				<textarea
					id="textInput"
					type="textarea"
					class="add-form-text"
					placeholder="Введите ваш комментарий"
					rows="4"
				></textarea>
				<div class="add-form-row">
					<button id="add-form-button" class="add-form-button">Написать</button>
				</div>
			</div>
		</div>
	</body>
	<style>
		.error {
			background-color: rgb(221, 157, 157);
		}

		
	</style>
	<script>
		const buttonElement = document.getElementById('add-form-button');

		const listElement = document.getElementById('idComments');

		const buttonNameInput = document.getElementById('nameInput');

		const buttonTextInput = document.getElementById('textInput');

		const buttonsLike = document.querySelectorAll('.like-button');

		const likesCounter = document.querySelectorAll('.likes-counter');

		const commentsLi = document.querySelectorAll('.comment');

		const addForm = document.querySelector('.add-form');

		const addComment = document.querySelector('.add-comment');

		const container = document.querySelector('.container');

		const isLikeLoading = document.querySelector('.-loading-like');

		let allComments = [];

		const getComments = () => {
			return fetch(
				'https://webdev-hw-api.vercel.app/api/v1/dmitry-bobrov/comments',
				{
					method: 'GET',
				}
			)
				.then(response => {
					return response.json();
				})
				.then(responseData => {
					allComments = responseData.comments.map(man => {
						return {
							name: man.author.name,
							date: `${
								new Date(man.date).toLocaleDateString().slice(0, 6) +
								`${new Date(man.date).toLocaleDateString().slice(8)}`
							}  ${new Date(man.date).toLocaleTimeString().slice(0, -3)}`,
							text: man.text,
							countLike: man.likes,
							likeComment: false,
						};
					});
					renderPeople();
				});
		};

		const renderPeople = () => {
			const commentsHTML = allComments

				.map((man, index) => {
					return `<li  class="comment" data-index = '${index}'>
						
			        <div class="comment-header">
			          <div>${man.name}</div>
			          <div>${man.date}</div>
			        </div>
			        <div  class="comment-body">
								
			            <div style = 'word-wrap: break-word' class="comment-text">
										
			              ${man.text}
			            </div>
			          </div>
			          <div class="comment-footer">
			            <div class="likes" >
			              <span   class="likes-counter">${man.countLike}</span>
										<button data-index = '${index}'  class="like-button  ${
						man.likeComment ? '-active-like ' : ''
					} ${man.isLikeLoading ? '-loading-like' : ''}" ></button>
			            </div>
			          </div>
			      </li>`;
				})
				.join('');

			listElement.innerHTML = commentsHTML;

			initEventListeners();
			commentAnswer();
		};
		const initEventListeners = () => {
			const buttonsLike = document.querySelectorAll('.like-button');
			for (const buttonLike of buttonsLike) {
				const index = buttonLike.dataset.index;

				buttonLike.addEventListener('click', event => {
					event.stopPropagation();
					function delay(interval = 300) {
						return new Promise(resolve => {
							setTimeout(() => {
								resolve();
							}, interval);
						});
					}
					allComments[index].isLikeLoading = true;
					delay(1000).then(() => {
						allComments[index].countLike = allComments[index].likeComment
							? allComments[index].countLike - 1
							: allComments[index].countLike + 1;
						allComments[index].likeComment = !allComments[index].likeComment;
						allComments[index].isLikeLoading = false;
						renderPeople();
					});
					renderPeople();
				});
			}
		};
		const commentAnswer = () => {
			for (const commentLi of commentsLi) {
				const index = commentLi.dataset.index;
				commentLi.addEventListener('click', () => {
					buttonTextInput.value = `${allComments[index].text}${'\n'}${
						allComments[index].name
					},`;
					renderPeople();
				});
			}
		};
		// addComment.remove()

		getComments();

		const realDate = `${
			new Date().toLocaleDateString().slice(0, 6) +
			`${new Date().toLocaleDateString().slice(8)}`
		}  ${new Date().toLocaleTimeString().slice(0, -3)}`;
		buttonNameInput.addEventListener('keyup', enterFunction);
		function enterFunction(event) {
			if (event.key === 'Enter') {
				buttonElement.click();
			}
		}
		buttonElement.addEventListener('click', () => {
			buttonNameInput.addEventListener(
				'input',
				() => (buttonElement.disabled = false)
			);
			buttonTextInput.addEventListener(
				'input',
				() => (buttonElement.disabled = false)
			);
			buttonNameInput.classList.remove('error');
			buttonTextInput.classList.remove('error');
			if (buttonNameInput.value === '' && buttonTextInput.value === '') {
				buttonNameInput.classList.add('error');
				buttonTextInput.classList.add('error');
				buttonElement.disabled = true;
				return;
			}
			if (buttonNameInput.value === '') {
				buttonNameInput.classList.add('error');
				buttonElement.disabled = true;
				return;
			}
			if (buttonTextInput.value === '') {
				buttonTextInput.classList.add('error');
				buttonElement.disabled = true;
				return;
			}
			
			let addDiv = document.createElement('div')

			addDiv.textContent = 'Комментарий добавляется...'

			container.appendChild(addDiv)

			addForm.classList.remove('add-form')
			
			addForm.innerHTML = ''

			fetch('https://webdev-hw-api.vercel.app/api/v1/dmitry-bobrov/comments', {
				method: 'POST',
				body: JSON.stringify({
					name: buttonNameInput.value
						.replaceAll('&', '&amp;')
						.replaceAll('<', '&lt;')
						.replaceAll('>', '&gt;')
						.replaceAll('"', '&quot;'),
					text: buttonTextInput.value
						.replaceAll('&', '&amp;')
						.replaceAll('<', '&lt;')
						.replaceAll('>', '&gt;')
						.replaceAll('"', '&quot;'),
					date: realDate,
					countLike: 0,
					likeComment: false,
				}),
			})
				.then(response => {
					return response.json();
				})
				.then(() => {
					return getComments();
				})
				.then(() => {
					container.removeChild(addDiv)
					addForm.classList.add('add-form')
					addForm.innerHTML = `<input
					id="nameInput"
					type="text"
					class="add-form-name"
					placeholder="Введите ваше имя"
				/>
				<textarea
					id="textInput"
					type="textarea"
					class="add-form-text"
					placeholder="Введите ваш комментарий"
					rows="4"
				></textarea>
				<div class="add-form-row">
					<button id="add-form-button" class="add-form-button">Написать</button>
				</div>`
				});

			renderPeople();
			buttonNameInput.value = '';
			buttonTextInput.value = '';
		});
	</script>
</html>
